<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2963px" preserveAspectRatio="none" style="width:1512px;height:2963px;background:#FFFFFF;" version="1.1" viewBox="0 0 1512 2963" width="1512px" zoomAndPan="magnify"><defs><filter height="300%" id="f1uqws1yqq7ovx" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="331" x="590.5" y="29.4023">how client middleware works(thriftbp)</text><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="1748.3594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="507" y="1121.5566"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="512" y="1163.8672"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="1094.7695" style="stroke:#A80036;stroke-width:1.0;" width="10" x="512" y="1236.1777"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="517" y="1844.4258"/><rect fill="#006400" filter="url(#f1uqws1yqq7ovx)" height="246.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="517" y="1916.7363"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="197.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="802" y="2579.4316"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="70.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="807" y="2706.9844"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="812" y="2749.2949"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="298.2793" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1176" y="1508.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="155" x2="155" y1="123.6875" y2="2878.916"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="511.5" x2="511.5" y1="123.6875" y2="2878.916"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="807" x2="807" y1="123.6875" y2="2878.916"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1181" x2="1181" y1="123.6875" y2="2878.916"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1290" x2="1290" y1="123.6875" y2="2878.916"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="137" y="120.7344">user</text><ellipse cx="155" cy="50.1992" fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M155,58.1992 L155,85.1992 M142,66.1992 L168,66.1992 M155,85.1992 L142,100.1992 M155,85.1992 L168,100.1992 " fill="none" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="137" y="2891.4512">user</text><ellipse cx="155" cy="2904.4043" fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M155,2912.4043 L155,2939.4043 M142,2920.4043 L168,2920.4043 M155,2939.4043 L142,2954.4043 M155,2939.4043 L168,2954.4043 " fill="none" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="89" x="465.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="472.5" y="108.7344">client_pool</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="89" x="465.5" y="2877.916"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="472.5" y="2898.4512">client_pool</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="138" x="736" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="743" y="108.7344">client_middleware</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="138" x="736" y="2877.916"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="743" y="2898.4512">client_middleware</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="1145" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="1152" y="108.7344">channel</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="1145" y="2877.916"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="1152" y="2898.4512">channel</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="122" x="1227" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108" x="1234" y="108.7344">apache thrift lib</text><rect fill="#FEFECE" filter="url(#f1uqws1yqq7ovx)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="122" x="1227" y="2877.916"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="108" x="1234" y="2898.4512">apache thrift lib</text><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="1748.3594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="507" y="1121.5566"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="512" y="1163.8672"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="1094.7695" style="stroke:#A80036;stroke-width:1.0;" width="10" x="512" y="1236.1777"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="517" y="1844.4258"/><rect fill="#006400" filter="url(#f1uqws1yqq7ovx)" height="246.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="517" y="1916.7363"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="197.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="802" y="2579.4316"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="70.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="807" y="2706.9844"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="28" style="stroke:#A80036;stroke-width:1.0;" width="10" x="812" y="2749.2949"/><rect fill="#FFFFFF" filter="url(#f1uqws1yqq7ovx)" height="298.2793" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1176" y="1508.8359"/><polygon fill="#A80036" points="500,150.998,510,154.998,500,158.998,504,154.998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="155" x2="506" y1="154.998" y2="154.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="162" y="150.2559">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="255" x="175" y="150.2559">client := service.NewBaseplateClientPool</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="512" x2="554" y1="184.3086" y2="184.3086"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="554" x2="554" y1="184.3086" y2="197.3086"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="513" x2="554" y1="197.3086" y2="197.3086"/><polygon fill="#A80036" points="523,193.3086,513,197.3086,523,201.3086,519,197.3086" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="519" y="179.5664">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="255" x="532" y="179.5664">BaseplateClientPoolConfig(cfg).Validate()</text><polygon fill="#A80036" points="795,222.6191,805,226.6191,795,230.6191,799,226.6191" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="512" x2="801" y1="226.6191" y2="226.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="519" y="221.877">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="532" y="221.877">BaseplateDefaultClientMiddlewares</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="255.9297" y2="255.9297"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="255.9297" y2="268.9297"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="268.9297" y2="268.9297"/><polygon fill="#A80036" points="818,264.9297,808,268.9297,818,272.9297,814,268.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="251.1875">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="827" y="251.1875">ForwardEdgeRequestContext</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="298.2402" y2="298.2402"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="298.2402" y2="311.2402"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="311.2402" y2="311.2402"/><polygon fill="#A80036" points="818,307.2402,808,311.2402,818,315.2402,814,311.2402" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="293.498">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="827" y="293.498">SetClientName</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="340.5508" y2="340.5508"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="340.5508" y2="353.5508"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="353.5508" y2="353.5508"/><polygon fill="#A80036" points="818,349.5508,808,353.5508,818,357.5508,814,353.5508" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="335.8086">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="827" y="335.8086">MonitorClient</text><path d="M812,366.5508 L812,483.5508 L1268,483.5508 L1268,376.5508 L1258,366.5508 L812,366.5508 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1258,366.5508 L1258,376.5508 L1268,376.5508 L1258,366.5508 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="850" y="384.1191">This create spans from view of the client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302" x="850" y="399.4297">that group all retries into a single wrapped span</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="822" y="414.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="850" y="430.0508">MonitorClient(MonitorClientArgs{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403" x="850" y="445.3613">ServiceSlug:args.ServiceSlug + MonitorClientWrappedSlugSuffix,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="303" x="850" y="460.6719">ErrorSpanSuppressor: args.ErrorSpanSuppressor,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="818" y="475.9824">}),</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="529.3457" y2="529.3457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="529.3457" y2="542.3457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="542.3457" y2="542.3457"/><polygon fill="#A80036" points="818,538.3457,808,542.3457,818,546.3457,814,542.3457" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="516.9482">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="827" y="509.293">PrometheusClientMiddleware(args.ServiceSlug</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="831" y="524.6035">+ MonitorClientWrappedSlugSuffix),</text><path d="M812,555.3457 L812,595.3457 L1245,595.3457 L1245,565.3457 L1235,555.3457 L812,555.3457 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1235,555.3457 L1235,565.3457 L1245,565.3457 L1235,555.3457 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="818" y="572.9141">creates the prometheus client metrics from the view of the client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="818" y="588.2246">that group all retries into a single operation</text><line style="stroke:#FF00FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="626.2773" y2="626.2773"/><line style="stroke:#FF00FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="626.2773" y2="639.2773"/><line style="stroke:#FF00FF;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="639.2773" y2="639.2773"/><polygon fill="#FF00FF" points="818,635.2773,808,639.2773,818,643.2773,814,639.2773" style="stroke:#FF00FF;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="621.5352">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="827" y="621.5352">Retry(args.RetryOptions...)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="683.8984" y2="683.8984"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="683.8984" y2="696.8984"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="696.8984" y2="696.8984"/><polygon fill="#A80036" points="818,692.8984,808,696.8984,818,700.8984,814,696.8984" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="814" y="671.501">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="827" y="663.8457">breakerbp.NewFailureRatioBreaker(*args.BreakerConfig)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="827" y="679.1563">.ThriftMiddleware</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="726.209" y2="726.209"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="726.209" y2="739.209"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="739.209" y2="739.209"/><polygon fill="#A80036" points="818,735.209,808,739.209,818,743.209,814,739.209" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="814" y="721.4668">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="836" y="721.4668">MonitorClient</text><path d="M812,752.209 L812,884.209 L1224,884.209 L1224,762.209 L1214,752.209 L812,752.209 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1214,752.209 L1214,762.209 L1224,762.209 L1214,752.209 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="818" y="769.7773">MonitorClient again, but this happens before retry middleware</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="818" y="785.0879">so this will create raw client call</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="818" y="800.3984">notice the</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="157" x="885" y="800.3984">ServiceSlug differences</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="822" y="815.709"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="818" y="831.0195">MonitorClient(MonitorClientArgs{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="850" y="846.3301">ServiceSlug:         args.ServiceSlug,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="303" x="850" y="861.6406">ErrorSpanSuppressor: args.ErrorSpanSuppressor,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="818" y="876.9512">}),</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="915.0039" y2="915.0039"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="915.0039" y2="928.0039"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="928.0039" y2="928.0039"/><polygon fill="#A80036" points="818,924.0039,808,928.0039,818,932.0039,814,928.0039" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="814" y="910.2617">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="836" y="910.2617">PrometheusClientMiddleware(args.ServiceSlug)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="957.3145" y2="957.3145"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="957.3145" y2="970.3145"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="970.3145" y2="970.3145"/><polygon fill="#A80036" points="818,966.3145,808,970.3145,818,974.3145,814,970.3145" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="814" y="952.5723">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="836" y="952.5723">BaseplateErrorWrapper</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="999.625" y2="999.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="999.625" y2="1012.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="1012.625" y2="1012.625"/><polygon fill="#A80036" points="818,1008.625,808,1012.625,818,1016.625,814,1012.625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="814" y="994.8828">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271" x="836" y="994.8828">thrift.ExtractIDLExceptionClientMiddleware</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="849" y1="1041.9355" y2="1041.9355"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="849" x2="849" y1="1041.9355" y2="1054.9355"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="808" x2="849" y1="1054.9355" y2="1054.9355"/><polygon fill="#A80036" points="818,1050.9355,808,1054.9355,818,1058.9355,814,1054.9355" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="814" y="1037.1934">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="836" y="1037.1934">SetDeadlineBudget</text><polygon fill="#8A2BE2" points="523,1080.2461,513,1084.2461,523,1088.2461,519,1084.2461" style="stroke:#8A2BE2;stroke-width:1.0;"/><line style="stroke:#8A2BE2;stroke-width:1.0;" x1="517" x2="806" y1="1084.2461" y2="1084.2461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="529" y="1079.5039">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="551" y="1079.5039">middlewares</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="512" x2="559" y1="1108.5566" y2="1108.5566"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="559" x2="559" y1="1108.5566" y2="1121.5566"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="518" x2="559" y1="1121.5566" y2="1121.5566"/><polygon fill="#A80036" points="528,1117.5566,518,1121.5566,528,1125.5566,524,1121.5566" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="524" y="1103.8145">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="546" y="1103.8145">NewCustomClientPool</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="564" y1="1155.8672" y2="1155.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="564" x2="564" y1="1155.8672" y2="1168.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="523" x2="564" y1="1168.8672" y2="1168.8672"/><polygon fill="#A80036" points="533,1164.8672,523,1168.8672,533,1172.8672,529,1168.8672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="529" y="1151.125">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="551" y="1151.125">cfg.Validate</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="517" x2="564" y1="1223.1777" y2="1223.1777"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="564" x2="564" y1="1223.1777" y2="1236.1777"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="523" x2="564" y1="1236.1777" y2="1236.1777"/><polygon fill="#A80036" points="533,1232.1777,523,1236.1777,533,1240.1777,529,1236.1777" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="529" y="1218.4355">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="551" y="1218.4355">newClientPool</text><path d="M214,1254.1777 L214,1478.1777 L498,1478.1777 L498,1264.1777 L488,1254.1777 L214,1254.1777 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M488,1254.1777 L488,1264.1777 L498,1264.1777 L488,1254.1777 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="220" y="1271.7461">prepare opener</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="224" y="1287.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="220" y="1302.3672">opener := func() (clientpool.Client, error) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="252" y="1317.6777">return newClient(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="284" y="1332.9883">tConfig,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="284" y="1348.2988">cfg.ServiceSlug,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="284" y="1363.6094">cfg.MetricsTags,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="284" y="1378.9199">cfg.MaxConnectionAge,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="284" y="1394.2305">jitter,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="284" y="1409.541">genAddr,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="38" x="284" y="1424.8516">proto,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="252" y="1440.1621">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="220" y="1455.4727">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="224" y="1470.7832"/><polygon fill="#A80036" points="1164,1504.8359,1174,1508.8359,1164,1512.8359,1168,1508.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="522" x2="1170" y1="1508.8359" y2="1508.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="529" y="1504.0938">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="551" y="1504.0938">NewChannelPool</text><path d="M761,1521.8359 L761,1775.8359 L1167,1775.8359 L1167,1531.8359 L1157,1521.8359 L761,1521.8359 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1157,1521.8359 L1157,1531.8359 L1167,1531.8359 L1157,1521.8359 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="295" x="767" y="1539.4043">create multiple clietns and place in channel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="771" y="1554.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="767" y="1570.0254">pool := make(chan Client, maxClients)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="767" y="1585.3359">for i := 0; i &lt; initialClients; i++ {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="799" y="1600.6465">c, err := opener()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="799" y="1615.957">if err != nil {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="831" y="1631.2676">finalErr = fmt.Errorf(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="289" x="863" y="1646.5781">"clientpool: error creating client #%d/%d: %w",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="863" y="1661.8887">i,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="863" y="1677.1992">initialClients,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="863" y="1692.5098">err,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="831" y="1707.8203">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="831" y="1723.1309">break</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="799" y="1738.4414">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="799" y="1753.752">pool &lt;- c</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="767" y="1769.0625">}</text><polygon fill="#A80036" points="533,1803.1152,523,1807.1152,533,1811.1152,529,1807.1152" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="527" x2="1180" y1="1807.1152" y2="1807.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="539" y="1802.373">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="561" y="1802.373">return channelPool</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="527" x2="569" y1="1836.4258" y2="1836.4258"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="569" x2="569" y1="1836.4258" y2="1849.4258"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="528" x2="569" y1="1849.4258" y2="1849.4258"/><polygon fill="#A80036" points="538,1845.4258,528,1849.4258,538,1853.4258,534,1849.4258" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="534" y="1831.6836">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="556" y="1831.6836">poolClient := &amp;clientPool{}</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="569" y1="1903.7363" y2="1903.7363"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="569" x2="569" y1="1903.7363" y2="1916.7363"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="528" x2="569" y1="1916.7363" y2="1916.7363"/><polygon fill="#A80036" points="538,1912.7363,528,1916.7363,538,1920.7363,534,1916.7363" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="534" y="1898.9941">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="556" y="1898.9941">pooledClient.wrapCalls(middlewares...)</text><polygon fill="#FF00FF" points="1278,1947.0469,1288,1951.0469,1278,1955.0469,1282,1951.0469" style="stroke:#FF00FF;stroke-width:1.0;"/><line style="stroke:#FF00FF;stroke-width:1.0;" x1="527" x2="1284" y1="1951.0469" y2="1951.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="534" y="1946.3047">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="556" y="1946.3047">WrapClient</text><path d="M5,1964.0469 L5,2127.0469 L498,2127.0469 L498,1974.0469 L488,1964.0469 L5,1964.0469 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M488,1964.0469 L488,1974.0469 L498,1974.0469 L488,1964.0469 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="185" x="11" y="1981.6152">form a closure, critical code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="15" y="1996.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="460" x="11" y="2012.2363">func WrapClient(client TClient, middlewares ...ClientMiddleware) TClient {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="440" x="43" y="2027.5469">// Add middlewares in reverse so the first in the list is the outermost.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="43" y="2042.8574">for i := len(middlewares) - 1; i &gt;= 0; i-- {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="75" y="2058.168">client = middlewares[i](client)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="43" y="2073.4785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="43" y="2088.7891">return client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="11" y="2104.0996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="15" y="2119.4102"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="527" x2="569" y1="2162.4629" y2="2162.4629"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="569" x2="569" y1="2162.4629" y2="2175.4629"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="569" y1="2175.4629" y2="2175.4629"/><polygon fill="#A80036" points="532,2171.4629,522,2175.4629,532,2179.4629,528,2175.4629" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="534" y="2157.7207">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="556" y="2157.7207">p.wrappedClient = thrift.WrapClient</text><path d="M527,2183.4629 L527,2300.4629 L1281,2300.4629 L1281,2193.4629 L1271,2183.4629 L527,2183.4629 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1271,2183.4629 L1271,2193.4629 L1281,2193.4629 L1271,2183.4629 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="533" y="2201.0313">notice return pooledCall</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="537" y="2216.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="565" y="2231.6523">p.wrappedClient = thrift.WrapClient(thrift.WrappedTClient{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="669" x="597" y="2246.9629">Wrapped: func(ctx context.Context, method string, args, result thrift.TStruct) (thrift.ResponseMeta, error) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284" x="629" y="2262.2734">return p.pooledCall(ctx, method, args, result)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="597" y="2277.584">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="565" y="2292.8945">}, middlewares...)</text><polygon fill="#A80036" points="166,2326.9473,156,2330.9473,166,2334.9473,162,2330.9473" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="506" y1="2330.9473" y2="2330.9473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="172" y="2326.2051">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="194" y="2326.2051">return clientPool</text><polygon fill="#A80036" points="495,2356.2578,505,2360.2578,495,2364.2578,499,2360.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="155" x2="501" y1="2360.2578" y2="2360.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="162" y="2355.5156">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="184" y="2355.5156">client := service.NewServiceClient(pool.TClient())</text><path d="M128,2373.2578 L128,2413.2578 L498,2413.2578 L498,2383.2578 L488,2373.2578 L128,2373.2578 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M488,2373.2578 L488,2383.2578 L498,2383.2578 L488,2373.2578 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="349" x="134" y="2390.8262">NewServiceClient would be generated by thrift compiler</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="134" y="2406.1367">for ex NewThingServiceClient</text><polygon fill="#A80036" points="166,2440.1895,156,2444.1895,166,2448.1895,162,2444.1895" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="506" y1="2444.1895" y2="2444.1895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="172" y="2439.4473">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="194" y="2439.4473">ServiceClient</text><polygon fill="#A80036" points="1278,2469.5,1288,2473.5,1278,2477.5,1282,2473.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="155" x2="1284" y1="2473.5" y2="2473.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="162" y="2468.7578">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="184" y="2468.7578">Client.Call(ctx, method, args, result)</text><path d="M1129,2486.5 L1129,2511.5 L1281,2511.5 L1281,2496.5 L1271,2486.5 L1129,2486.5 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1271,2486.5 L1271,2496.5 L1281,2496.5 L1271,2486.5 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="1135" y="2504.0684">thrift/middleware.go</text><polygon fill="#A80036" points="818,2538.1211,808,2542.1211,818,2546.1211,814,2542.1211" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="812" x2="1289" y1="2542.1211" y2="2542.1211"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="824" y="2537.3789">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="846" y="2537.3789">return c.Wrapped</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="807" x2="854" y1="2566.4316" y2="2566.4316"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="854" x2="854" y1="2566.4316" y2="2579.4316"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="813" x2="854" y1="2579.4316" y2="2579.4316"/><polygon fill="#A80036" points="823,2575.4316,813,2579.4316,823,2583.4316,819,2579.4316" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="819" y="2561.6895">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="294" x="841" y="2561.6895">ForwardEdgeRequestContext::return next.Call()</text><path d="M817,2597.4316 L817,2668.4316 L1503,2668.4316 L1503,2607.4316 L1493,2597.4316 L817,2597.4316 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1493,2597.4316 L1493,2607.4316 L1503,2607.4316 L1493,2597.4316 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="665" x="823" y="2615">Wrapped: func(ctx context.Context, method string, args, result thrift.TStruct)(thrift.ResponseMeta, error) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="855" y="2630.3105">ctx = AttachEdgeRequestContext(ctx, ecImpl)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="855" y="2645.6211">return next.Call(ctx, method, args, result)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="823" y="2660.9316">},</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="812" x2="859" y1="2693.9844" y2="2693.9844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="859" x2="859" y1="2693.9844" y2="2706.9844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="818" x2="859" y1="2706.9844" y2="2706.9844"/><polygon fill="#A80036" points="828,2702.9844,818,2706.9844,828,2710.9844,824,2706.9844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="824" y="2689.2422">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="846" y="2689.2422">setClientName: return next.Call</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="822" x2="864" y1="2741.2949" y2="2741.2949"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="864" x2="864" y1="2741.2949" y2="2754.2949"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="823" x2="864" y1="2754.2949" y2="2754.2949"/><polygon fill="#A80036" points="833,2750.2949,823,2754.2949,833,2758.2949,829,2754.2949" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="829" y="2736.5527">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="200" x="851" y="2736.5527">MonitorClient: return next.Call()</text><path d="M812,2797.2949 L812,2830.2949 L1027,2830.2949 L1027,2807.2949 L1017,2797.2949 L812,2797.2949 " fill="#FBFB77" filter="url(#f1uqws1yqq7ovx)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1017,2797.2949 L1017,2807.2949 L1027,2807.2949 L1017,2797.2949 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="818" y="2814.8633">there are multiple middlewares</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,2.0;" x1="813" x2="1026" y1="2817.6055" y2="2817.6055"/><polygon fill="#A80036" points="166,2856.916,156,2860.916,166,2864.916,162,2860.916" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="160" x2="806" y1="2860.916" y2="2860.916"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="172" y="2856.1738">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="194" y="2856.1738">result of "client.Call"</text><!--MD5=[f2e1d01dc40f9e1ce4cedb9c7bc9a4f7]
@startuml
title "how client middleware works(thriftbp)"
autonumber
actor "user" as cc
participant client_pool as cp 
participant client_middleware as cm
participant channel as ch
participant "apache thrift lib" as atl

cc->cp: client := service.NewBaseplateClientPool
cp- ->cp: BaseplateClientPoolConfig(cfg).Validate()
cp->cm: BaseplateDefaultClientMiddlewares
cm- ->cm: ForwardEdgeRequestContext
cm- ->cm: SetClientName
cm- ->cm: MonitorClient
note right of cm
	This create spans from view of the client
	that group all retries into a single wrapped span

	MonitorClient(MonitorClientArgs{
	ServiceSlug:args.ServiceSlug + MonitorClientWrappedSlugSuffix,
	ErrorSpanSuppressor: args.ErrorSpanSuppressor,
}),
end note
cm- ->cm: PrometheusClientMiddleware(args.ServiceSlug\n + MonitorClientWrappedSlugSuffix),
note right of cm
creates the prometheus client metrics from the view of the client 
that group all retries into a single operation
end note
cm-[#Magenta]->cm: Retry(args.RetryOptions...)

cm- ->cm: breakerbp.NewFailureRatioBreaker(*args.BreakerConfig)\n.ThriftMiddleware
cm- ->cm: MonitorClient
note right of cm
MonitorClient again, but this happens before retry middleware
so this will create raw client call
notice the **<color red>ServiceSlug differences</color>**

MonitorClient(MonitorClientArgs{
	ServiceSlug:         args.ServiceSlug,
	ErrorSpanSuppressor: args.ErrorSpanSuppressor,
}),
end note 

cm- ->cm:PrometheusClientMiddleware(args.ServiceSlug)
cm- ->cm: BaseplateErrorWrapper
cm- ->cm: thrift.ExtractIDLExceptionClientMiddleware
cm- ->cm: SetDeadlineBudget
cm-[#BlueViolet]>cp: middlewares
cp- ->cp: NewCustomClientPool
activate cp
cp- ->cp: cfg.Validate
activate cp
deactivate cp
cp- ->cp: newClientPool
note left of cp
prepare opener 

opener := func() (clientpool.Client, error) {
	return newClient(
		tConfig,
		cfg.ServiceSlug,
		cfg.MetricsTags,
		cfg.MaxConnectionAge,
		jitter,
		genAddr,
		proto,
	)
}

end note
activate cp
cp->ch: NewChannelPool
activate ch
note left of ch
**<color: red>create multiple clietns and place in channel</color>**

pool := make(chan Client, maxClients)
for i := 0; i < initialClients; i++ {
	c, err := opener()
	if err != nil {
		finalErr = fmt.Errorf(
			"clientpool: error creating client #%d/%d: %w",
			i,
			initialClients,
			err,
		)
		break
	}
	pool <- c
}
end note
ch- ->cp: return channelPool
deactivate ch
cp- ->cp: poolClient := &clientPool{}
activate cp
deactivate cp
cp- ->cp: pooledClient.wrapCalls(middlewares...)
activate cp #DarkGreen
cp-[#Magenta]>atl: WrapClient
note left of cp
**<color: red>form a closure, critical code</color>**

func WrapClient(client TClient, middlewares ...ClientMiddleware) TClient {
	// Add middlewares in reverse so the first in the list is the outermost.
	for i := len(middlewares) - 1; i >= 0; i- - {
		client = middlewares[i](client)
	}
	return client
}

end note
cp- ->cp: p.wrappedClient = thrift.WrapClient
note right of cp
**<color:red>notice return pooledCall</color>**

	p.wrappedClient = thrift.WrapClient(thrift.WrappedTClient{
		Wrapped: func(ctx context.Context, method string, args, result thrift.TStruct) (thrift.ResponseMeta, error) {
			return p.pooledCall(ctx, method, args, result)
		},
	}, middlewares...)
end note


deactivate cp
cp->cc: return clientPool
deactivate cp

cc->cp: client := service.NewServiceClient(pool.TClient())
note left of cp
NewServiceClient would be generated by thrift compiler
for ex NewThingServiceClient
end note
cp->cc: ServiceClient
cc->atl: Client.Call(ctx, method, args, result)
note left of atl
thrift/middleware.go
end note
atl->cm:return c.Wrapped
cm- ->cm: ForwardEdgeRequestContext::return next.Call()
activate cm 
note right of cm
Wrapped: func(ctx context.Context, method string, args, result thrift.TStruct)(thrift.ResponseMeta, error) {
	ctx = AttachEdgeRequestContext(ctx, ecImpl)
	return next.Call(ctx, method, args, result)
},
end note
cm- ->cm: setClientName: return next.Call
activate cm
cm- ->cm: MonitorClient: return next.Call()
activate cm
note right of cm
there are multiple middlewares
....
end note
deactivate cm
deactivate cm
deactivate cm

cm->cc: result of "client.Call"
@enduml

PlantUML version 1.2021.11(Sat Oct 02 06:26:11 PDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>