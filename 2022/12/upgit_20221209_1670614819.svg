<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1514px" preserveAspectRatio="none" style="width:1379px;height:1514px;background:#FFFFFF;" version="1.1" viewBox="0 0 1379 1514" width="1379px" zoomAndPan="magnify"><defs><filter height="300%" id="f11ks9dyijz62w" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="191" x="591.5" y="29.4023">how span hook works</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="52" x2="52" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="203.5" x2="203.5" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="441" x2="441" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="527" x2="527" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="705.5" x2="705.5" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="995.5" x2="995.5" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1240" x2="1240" y1="123.6875" y2="1430.457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1329" x2="1329" y1="123.6875" y2="1430.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="5" y="120.7344">tracing_code</text><ellipse cx="52" cy="50.1992" fill="#FEFECE" filter="url(#f11ks9dyijz62w)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M52,58.1992 L52,85.1992 M39,66.1992 L65,66.1992 M52,85.1992 L39,100.1992 M52,85.1992 L65,100.1992 " fill="none" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="5" y="1442.9922">tracing_code</text><ellipse cx="52" cy="1455.9453" fill="#FEFECE" filter="url(#f11ks9dyijz62w)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M52,1463.9453 L52,1490.9453 M39,1471.9453 L65,1471.9453 M52,1490.9453 L39,1505.9453 M52,1490.9453 L65,1505.9453 " fill="none" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="49" x="177.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35" x="184.5" y="108.7344">hook</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="49" x="177.5" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35" x="184.5" y="1449.9922">hook</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="78" x="400" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="407" y="108.7344">hooks.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="78" x="400" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="407" y="1449.9922">hooks.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="66" x="492" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="499" y="108.7344">thriftbp</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="66" x="492" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="499" y="1449.9922">thriftbp</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="69" x="669.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="676.5" y="108.7344">span.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="69" x="669.5" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="676.5" y="1449.9922">span.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="97" x="945.5" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="952.5" y="108.7344">opentracing</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="97" x="945.5" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83" x="952.5" y="1449.9922">opentracing</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="70" x="1203" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1210" y="108.7344">trace.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="70" x="1203" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="1210" y="1449.9922">trace.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="76" x="1289" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="1296" y="108.7344">tracer.go</text><rect fill="#FEFECE" filter="url(#f11ks9dyijz62w)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="76" x="1289" y="1429.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="1296" y="1449.9922">tracer.go</text><polygon fill="#A80036" points="192,150.998,202,154.998,192,158.998,196,154.998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="52" x2="198" y1="154.998" y2="154.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="59" y="150.2559">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="72" y="150.2559">create hook struct</text><polygon fill="#A80036" points="429,180.3086,439,184.3086,429,188.3086,433,184.3086" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="204" x2="435" y1="184.3086" y2="184.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="211" y="179.5664">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="200" x="224" y="179.5664">RegisterCreateServerSpanHooks</text><path d="M32,197.3086 L32,314.3086 L195,314.3086 L195,207.3086 L185,197.3086 L32,197.3086 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M185,197.3086 L185,207.3086 L195,207.3086 L185,197.3086 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="38" y="214.877">hook implement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="38" y="230.1875">CreateServerSpanHook</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="38" y="245.498">CreateChildSpanHook</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="38" y="260.8086">SetSpanTagHook</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="38" y="276.1191">StartStopSpanHook</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="38" y="291.4297">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="38" y="306.7402">interface</text><polygon fill="#A80036" points="515,340.793,525,344.793,515,348.793,519,344.793" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="52" x2="521" y1="344.793" y2="344.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="59" y="340.0508">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="72" y="340.0508">StartSpanFromThriftContext</text><path d="M360,357.793 L360,382.793 L518,382.793 L518,367.793 L508,357.793 L360,357.793 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M508,357.793 L508,367.793 L518,367.793 L508,357.793 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="366" y="375.3613">server_middleware.go</text><polygon fill="#A80036" points="694,409.4141,704,413.4141,694,417.4141,698,413.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="527" x2="700" y1="413.4141" y2="413.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="534" y="408.6719">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="547" y="408.6719">StartSpanFromHeaders</text><path d="M397,426.4141 L397,512.4141 L697,512.4141 L697,436.4141 L687,426.4141 L397,426.4141 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M687,426.4141 L687,436.4141 L697,436.4141 L687,426.4141 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279" x="403" y="443.9824">span := newSpan(nil, name, SpanTypeServer)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="403" y="459.293">defer func() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="435" y="474.6035">onCreateServerSpan(span)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="435" y="489.9141">span.onStart()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="403" y="505.2246">}()</text><polygon fill="#A80036" points="984,539.2773,994,543.2773,984,547.2773,988,543.2773" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="706" x2="990" y1="543.2773" y2="543.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="713" y="538.5352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253" x="726" y="538.5352">opentracing.ContextWithSpan(ctx, span)</text><path d="M618,556.2773 L618,596.2773 L987,596.2773 L987,566.2773 L977,556.2773 L618,556.2773 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M977,556.2773 L977,566.2773 L987,566.2773 L977,556.2773 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="348" x="624" y="573.8457">ctx = tracerWithHook.ContextWithSpanHook(ctx, span)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="624" y="589.1563">return context.WithValue(ctx, activeSpanKey, span)</text><polygon fill="#A80036" points="717,623.209,707,627.209,717,631.209,713,627.209" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="711" x2="995" y1="627.209" y2="627.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="723" y="622.4668">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="736" y="622.4668">return ctx</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="706" x2="748" y1="656.5195" y2="656.5195"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="748" x2="748" y1="656.5195" y2="669.5195"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="707" x2="748" y1="669.5195" y2="669.5195"/><polygon fill="#A80036" points="717,665.5195,707,669.5195,717,673.5195,713,669.5195" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="713" y="651.7773">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="726" y="651.7773">initRootSpan</text><path d="M711,682.5195 L711,768.5195 L985,768.5195 L985,692.5195 L975,682.5195 L711,682.5195 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M975,682.5195 L975,692.5195 L985,692.5195 L975,682.5195 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="717" y="700.0879">ctx = log.Attach(ctx, log.AttachArgs{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="749" y="715.3984">TraceID: s.TraceID(),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="717" y="730.709">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253" x="717" y="746.0195">s.hub = sentry.GetHubFromContext(ctx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="717" y="761.3301">return ctx</text><polygon fill="#A80036" points="538,795.3828,528,799.3828,538,803.3828,534,799.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="532" x2="705" y1="799.3828" y2="799.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="544" y="794.6406">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="557" y="794.6406">return ctx, span</text><polygon fill="#A80036" points="694,824.6934,704,828.6934,694,832.6934,698,828.6934" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="527" x2="700" y1="828.6934" y2="828.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="534" y="823.9512">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="42" x="547" y="823.9512">SetTag</text><path d="M196,841.6934 L196,1019.6934 L697,1019.6934 L697,851.6934 L687,841.6934 L196,841.6934 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M687,841.6934 L687,851.6934 L697,851.6934 L687,841.6934 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="202" y="859.2617">trigger all hooks which implement SetSpanTagHook</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="206" y="874.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="202" y="889.8828">s.trace.setTag(key, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="202" y="905.1934">for _, h := range s.hooks {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="234" y="920.5039">if hook, ok := h.(SetSpanTagHook); ok {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="305" x="266" y="935.8145">if err := hook.OnSetTag(s, key, value); err != nil {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="384" x="298" y="951.125">s.logError(context.Background(), "OnSetTag hook error: ", err)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="266" y="966.4355">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="234" y="981.7461">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="202" y="997.0566">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="202" y="1012.3672">return s</text><polygon fill="#A80036" points="538,1046.4199,528,1050.4199,538,1054.4199,534,1050.4199" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="532" x2="705" y1="1050.4199" y2="1050.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="544" y="1045.6777">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="566" y="1045.6777">return span</text><polygon fill="#A80036" points="984,1075.7305,994,1079.7305,984,1083.7305,988,1079.7305" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="52" x2="990" y1="1079.7305" y2="1079.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="59" y="1074.9883">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="81" y="1074.9883">StartSpanFromContext</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="996" x2="1038" y1="1109.041" y2="1109.041"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1038" x2="1038" y1="1109.041" y2="1122.041"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="997" x2="1038" y1="1122.041" y2="1122.041"/><polygon fill="#A80036" points="1007,1118.041,997,1122.041,1007,1126.041,1003,1122.041" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1003" y="1104.2988">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1025" y="1104.2988">StartSpanFromContextWithTracer</text><path d="M1001,1135.041 L1001,1206.041 L1325,1206.041 L1325,1145.041 L1315,1135.041 L1001,1135.041 " fill="#FBFB77" filter="url(#f11ks9dyijz62w)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1315,1135.041 L1315,1145.041 L1325,1145.041 L1315,1135.041 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174" x="1007" y="1152.6094">this call will generate tracer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="1011" y="1167.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="303" x="1007" y="1183.2305">span := tracer.StartSpan(operationName, opts...)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1007" y="1198.541">return span, ContextWithSpan(ctx, span)</text><polygon fill="#A80036" points="1317,1232.5938,1327,1236.5938,1317,1240.5938,1321,1236.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="996" x2="1323" y1="1236.5938" y2="1236.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1003" y="1231.8516">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="1025" y="1231.8516">StartSpan</text><polygon fill="#A80036" points="1007,1261.9043,997,1265.9043,1007,1269.9043,1003,1265.9043" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1001" x2="1328" y1="1265.9043" y2="1265.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1013" y="1261.1621">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="1035" y="1261.1621">return span</text><polygon fill="#A80036" points="63,1291.2148,53,1295.2148,63,1299.2148,59,1295.2148" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="57" x2="995" y1="1295.2148" y2="1295.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="69" y="1290.4727">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="91" y="1290.4727">span</text><polygon fill="#A80036" points="694,1320.5254,704,1324.5254,694,1328.5254,698,1324.5254" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="52" x2="700" y1="1324.5254" y2="1324.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="59" y="1319.7832">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="81" y="1319.7832">AddCounter</text><polygon fill="#A80036" points="694,1349.8359,704,1353.8359,694,1357.8359,698,1353.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="52" x2="700" y1="1353.8359" y2="1353.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="59" y="1349.0938">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="81" y="1349.0938">Stop</text><polygon fill="#A80036" points="1228,1379.1465,1238,1383.1465,1228,1387.1465,1232,1383.1465" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="706" x2="1234" y1="1383.1465" y2="1383.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="713" y="1378.4043">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="735" y="1378.4043">publish</text><polygon fill="#A80036" points="1317,1408.457,1327,1412.457,1317,1416.457,1321,1412.457" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1240" x2="1323" y1="1412.457" y2="1412.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1247" y="1407.7148">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="1269" y="1407.7148">Record</text><!--MD5=[77f06ad77c42b07fc7405eb6e9f33e3e]
@startuml
title "how span hook works"
autonumber
actor tracing_code as tc
participant hook as hk
participant hooks.go as hgo
participant thriftbp as tbp
participant span.go as spg
participant opentracing as opt
participant trace.go as tg
participant tracer.go as trg

tc -> hk : create hook struct
hk -> hgo: RegisterCreateServerSpanHooks
note left of hk
	hook implement 
	CreateServerSpanHook
	CreateChildSpanHook
	SetSpanTagHook
	StartStopSpanHook
	...
	interface
end note
tc->tbp: StartSpanFromThriftContext
note left of tbp
	server_middleware.go
end note

tbp->spg: StartSpanFromHeaders
note left of spg
	span := newSpan(nil, name, SpanTypeServer)
	defer func() {
		onCreateServerSpan(span)
		span.onStart()
	}()
end note

spg->opt: opentracing.ContextWithSpan(ctx, span)
note left of opt
	ctx = tracerWithHook.ContextWithSpanHook(ctx, span)
	return context.WithValue(ctx, activeSpanKey, span)
end note

opt->spg: return ctx

spg- ->spg: initRootSpan
note right of spg
	ctx = log.Attach(ctx, log.AttachArgs{
		TraceID: s.TraceID(),
	})
	s.hub = sentry.GetHubFromContext(ctx)
	return ctx
end note

spg->tbp: return ctx, span

tbp->spg: SetTag
note left of spg
	trigger all hooks which implement SetSpanTagHook

	s.trace.setTag(key, value)
	for _, h := range s.hooks {
		if hook, ok := h.(SetSpanTagHook); ok {
			if err := hook.OnSetTag(s, key, value); err != nil {
				s.logError(context.Background(), "OnSetTag hook error: ", err)
			}
		}
	}
	return s
end note

spg->tbp: return span
tc->opt: StartSpanFromContext
opt- ->opt: StartSpanFromContextWithTracer
note right of opt
	this call will generate tracer

	span := tracer.StartSpan(operationName, opts...)
	return span, ContextWithSpan(ctx, span)
end note

opt->trg: StartSpan
trg->opt: return span

opt->tc: span

tc->spg: AddCounter
tc->spg: Stop
spg->tg: publish

tg->trg: Record

@enduml

PlantUML version 1.2021.11(Sat Oct 02 06:26:11 PDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>